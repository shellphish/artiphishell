#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $SCRIPT_DIR/../
PIPELINES_DIR=$(realpath ../../../)
TARGETS_DIR="$PIPELINES_DIR/components/pipeline/targets/"
KERNEL_CVE_DIR="$PIPELINES_DIR/components/pipeline/Kernel-CVE-Reproducer/"

pushd $TARGETS_DIR/Kernel/CVE-2016-0728/kasan_kernel
./getKasan.sh
/bin/bash -c 'shopt -s dotglob && cd kernel-v4.15 && tar -czvf ../linux.tar.gz * && shopt -u dotglob'
popd


pdl

pd inject syzkaller_build.kernel_root_dir 1 < $TARGETS_DIR/Kernel/CVE-2016-0728/kasan_kernel/linux.tar.gz
pd inject syzkaller_build.kernel_config 1 < $TARGETS_DIR/Kernel/CVE-2016-0728/kasan_kernel/kernel-v4.15/.config

pd run
# TODO check for crashes with correct title

exit 1
