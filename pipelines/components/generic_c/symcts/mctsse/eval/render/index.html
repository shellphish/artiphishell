<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>

<!-- Load c3.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css" integrity="sha512-cznfNokevSG7QPA5dZepud8taylLdvgr0lDqw/FEZIhluFsSwyvS81CMnRdrNSKwbsmc43LtRd2/WMQV+Z85AQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Load d3.js and c3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js" integrity="sha512-+IpCthlNahOuERYUSnKFjzjdKXIbJ/7Dd6xvUp+7bEw0Jp2dg6tluyxLs+zq9BMzZgrLv8886T4cBSqnKiVgUw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<body>
    <input type="file" id="file-input" accept=".json,text/json"/>
    <select id="node-selector" onChange="this.blur()"></select>

    <label for="branches-offset">Offset</label>
    <input id="branches-offset" type="number" style="width: 4em" value="0" step="10" min="0">

    <label for="branches-shown">#Branches</label>
    <input id="branches-shown" type="number" style="width: 4em" value="20" step="10" min="0">

    <label for="subsample">Subsampling</label>
    <input id="subsample" type="number" style="width: 4em" value="1" step="1" min="1">

    <label for="show-grid">Show Grid?</label>
    <label class="switch">
        <input id="show-grid" type="checkbox">
        <span class="slider round"></span>
    </label>

    <label for="log-scale">Log Scale?</label>
    <label class="switch">
        <input id="log-scale" type="checkbox">
        <span class="slider round"></span>
    </label>

    <input type="search" id="filter" placeholder="idx % 2 == 0 && counts[0] > 0">
    <button id="render-button">Render</button>

    <div id="chart_tick_counts"></div>
    <div id="chart_cumulative_counts"></div>
    <div id="chart_tick_percents"></div>
    <div id="chart_cumulative_percents"></div>

    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
</body>
<script>
function transform_counts_into_columns(counts, key) {
    let header = ['x']
    if (!counts) { return; }
    let tick = counts[0].tick;
    let branch_counts = counts[0][key];
    let node_names = Object.keys(branch_counts);
    if (!node_names) { return; }

    skip_one = key.includes('percent');
    
    let cols_by_node = {};
    node_names.forEach(node_name => {
        let cols = Object.keys(branch_counts[node_name]).map(x => [key.includes('percent') ? (2 * x) : x]);
        counts.forEach (p => {
            let tick = p.tick;
            branch_counts = p[key];
            header.push(tick);
            branch_counts[node_name].forEach((count, idx) => {
                cols[idx].push(count);
            });
        });
        cols_by_node[node_name] = cols;
    }); 
    return {header, cols_by_node}
}

function update_dropdown(node_names) {
    let node_selector = document.querySelector("#node-selector");
    let value = node_selector.value || node_names[0];

    options = node_names.map((name) => {
        let opt = document.createElement("option");
        opt.value = name;
        opt.text = name;
        return opt;
    })
    node_selector.replaceChildren(...options);
    node_selector.value = value;
}
function update_chart(key, counts) {
    // Preprocessing
    let num_branches_shown = +document.querySelector("#branches-shown").value;
    let branches_offset = +document.querySelector("#branches-offset").value;
    let subsample = +document.querySelector("#subsample").value;
    let {header, cols_by_node} = transform_counts_into_columns(counts, key);
    let mult = key.includes('percents') ? 1 : 2;
    for (node_name in cols_by_node) {
        cols_by_node[node_name] = cols_by_node[node_name]
                                    .slice(branches_offset * mult)
                                    .slice(
                                        0,
                                        mult * num_branches_shown
                                    )
                                    .map((column, idx) => {
                                        var result = [column[0]]; // skip the branch id
                                        for(var i = 1; i < column.length; i += subsample)
                                        {
                                            result.push(column.slice(i, i+subsample).reduce((prev, curr) => prev + curr) / (key.includes('percents') ? subsample : 1));
                                        }
                                        return result;
                                    });
    }

    // Plotting
    let selected_node = document.querySelector('#node-selector').value || 'master';
    let show_grid = document.querySelector('#show-grid').checked;
    var columns = cols_by_node[selected_node]
    if (document.querySelector('#log-scale').checked)
    {
        columns = columns.map(column => column.map((count, count_idx) => {
                return !count_idx || count <= 1 ? count : 1 + Math.log2(count)
            })
        );
    }
    let searchExpr = document.querySelector("#filter").value;
    if (searchExpr)
    {
        columns = columns.filter(column => {
            let [idx,...counts] = column;
            idx = +idx;
            return eval(searchExpr);
        });
    }
    let chart = c3.generate({
        bindto: '#chart_' + key,
        title: {
            text: key,
        },
        size: {
            height: 480,
        },
        data: {
            x: 'x',
            columns: [header, ...columns]
        },
        subchart: {
            show: true
        },
        grid: {
            x: {
                show: show_grid
            },
            y: {
                show: show_grid
            }
        },
        legend: {
            show: false
        }
    })
}

function render() {
    if (!tick_counts || !node_names) return;
    update_chart('tick_counts', tick_counts, );
    update_chart('cumulative_counts', tick_counts);
    update_chart('tick_percents', tick_counts);
    update_chart('cumulative_percents', tick_counts);
}
function load_tick_counts(file) {
    let reader = new FileReader();
    reader.addEventListener('load', function(e) {
            let text = e.target.result;
            let loaded = text.split('\n').filter(l => l).map(x => {
                return JSON.parse(x);
            });
            [node_names,...tick_counts] = loaded;
            const counts_loaded = new CustomEvent('counts_loaded', {detail: {node_names, tick_counts}});
            file_input.dispatchEvent(counts_loaded)
    });
    reader.readAsText(file);
}

var tick_counts = undefined;
var node_names = undefined;

let file_input = document.querySelector("#file-input");
if (file_input.files[0]) {
    load_tick_counts(file_input.files[0]);
}
file_input.addEventListener('change', () => {
    let file = file_input.files[0];
    load_tick_counts(file);
});

file_input.addEventListener('counts_loaded', (e) => {
    update_dropdown(e.detail.node_names);
})
document.querySelector("#render-button").addEventListener('click', (e) => render());
document.onkeyup = (e) => {
    if (e.code == 'Enter'){
        render();
        return false;
    }
}

</script>

<!-- Thanks https://www.w3schools.com/howto/howto_css_switch.asp -->
<style>
    /* The switch - the box around the slider */
    .switch {
     position: relative;
     display: inline-block;
     width: 32px;
     height: 18px;
   }

   /* Hide default HTML checkbox */
   .switch input {
     opacity: 0;
     width: 0;
     height: 0;
   }

   /* The slider */
   .slider {
     position: absolute;
     cursor: pointer;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background-color: #ccc;
     -webkit-transition: .4s;
     transition: .4s;
   }

   .slider:before {
     position: absolute;
     content: "";
     height: 14px;
     width: 14px;
     left: 2px;
     bottom: 2px;
     background-color: white;
     -webkit-transition: .4s;
     transition: .4s;
   }

   input:checked + .slider {
     background-color: #2196F3;
   }

   input:focus + .slider {
     box-shadow: 0 0 1px #2196F3;
   }

   input:checked + .slider:before {
     -webkit-transform: translateX(14px);
     -ms-transform: translateX(14px);
     transform: translateX(14px);
   }

   /* Rounded sliders */
   .slider.round {
     border-radius: 17px;
   }

   .slider.round:before {
     border-radius: 50%;
   }
   </style>
</html>