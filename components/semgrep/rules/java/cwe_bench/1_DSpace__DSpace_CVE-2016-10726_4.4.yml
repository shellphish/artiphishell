rules:
  - id: java-path-traversal-missing-colon-sanitization
    languages: [java]
    message: |
      [Path Traversal]: Potential Path Traversal (CWE-22) vulnerability detected.
      The input variable '$SOURCE_VAR' is being checked against a denylist of problematic
      strings (e.g., encoded dots, specific file extensions, parent directory indicators),
      but critical checks for colon (':') and encoded colon ('%3a') are missing.

    severity: ERROR
    metadata:
      cwe: "Path Traversal"
      vuln_type: "path-traversal"
      category: security
      confidence: HIGH
      # references:
      #  - DSpace: https://github.com/DSpace/DSpace/commit/4239abd2dd2ae0dedd7edc95a5c9f264fdcf639d

    patterns:
      - pattern: |
          if ($SOURCE_VAR != null && ($CONDITIONS_BLOCK)) {
            ...
          }
      # 1. The $CONDITIONS_BLOCK must show evidence of attempting path sanitization.
      #    Removed surrounding '...' from sub-patterns.
      - metavariable-pattern:
          metavariable: $CONDITIONS_BLOCK
          pattern-either:
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains("%252e")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains("%2e")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains("%2f")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains("%5c")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains("..")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains(".xmap")
            - pattern: |
                $SOURCE_VAR.toLowerCase().contains(".xsl")

      # 2. $CONDITIONS_BLOCK must NOT contain the check for a literal colon.
      #    Removed surrounding '...' from sub-patterns.
      - metavariable-pattern:
          metavariable: $CONDITIONS_BLOCK
          patterns:
            - pattern-not: |
                $SOURCE_VAR.toLowerCase().contains(":")

      # 3. $CONDITIONS_BLOCK must NOT contain the check for an encoded colon (%3a).
      #    Removed surrounding '...' from sub-patterns.
      - metavariable-pattern:
          metavariable: $CONDITIONS_BLOCK
          patterns:
            - pattern-not: |
                $SOURCE_VAR.toLowerCase().contains("%3a")