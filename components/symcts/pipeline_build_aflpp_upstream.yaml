# yaml-language-server: $schema=https://raw.githubusercontent.com/rhelmot/pydatatask/main/schema/pipeline.json

repo_classes:
  targets_with_sources:
    cls: FilesystemRepository
    compress_backend: true
    compress_backup: true
  target_metadatas: MetadataRepository


  built_targets:
    cls: FilesystemRepository
    compress_backend: true
    compress_backup: false
  cmplog_built_targets:
    cls: FilesystemRepository
    compress_backend: true
    compress_backup: false


tasks:
  symcts_build_aflpp_upstream:
    links:
      project_id:
        repo: targets_with_sources
        kind: InputId
      target_with_sources:
        repo: targets_with_sources
        kind: InputFilepath
      
      built_target:
        repo: built_targets
        kind: OutputFilepath
    


    executable:
      cls: Container
      args:
        image: aixcc-symcts

        host_mounts:
          "/shared": "/shared"
          "/var/run/docker.sock": "/var/run/docker.sock"
        template: |
          set -ex
          
          mkdir -p /shared/symcts_build_aflpp_upstream
          TEMP_DIR=$(mktemp -d /shared/symcts_build_aflpp_upstream/{{project_id}}_XXXXXX)
          rsync -raz {{ target_with_sources | shquote }}/ $TEMP_DIR/
          cd $TEMP_DIR

          cp /shellphish/guest_content/.env.docker.symcts_aflpp_upstream .env.docker
          cat /shellphish/guest_content/Dockerfile.extensions >> Dockerfile
          make docker-build
          ./run.sh build

          rsync -raz $TEMP_DIR/ {{ built_target | shquote }}/

  symcts_build_aflpp_upstream_cmplog:
    links:
      project_id:
        repo: targets_with_sources
        kind: InputId
      target_with_sources:
        repo: targets_with_sources
        kind: InputFilepath
      
      built_target:
        repo: cmplog_built_targets
        kind: OutputFilepath
    


    executable:
      cls: Container
      args:
        image: aixcc-symcts

        host_mounts:
          "/shared": "/shared"
          "/var/run/docker.sock": "/var/run/docker.sock"
        template: |
          set -ex
          
          mkdir -p /shared/symcts_build_aflpp_upstream_cmplog
          TEMP_DIR=$(mktemp -d /shared/symcts_build_aflpp_upstream_cmplog/{{project_id}}_XXXXXX)
          rsync -raz {{ target_with_sources | shquote }}/ $TEMP_DIR/
          cd $TEMP_DIR

          cp /shellphish/guest_content/.env.docker.symcts_aflpp_upstream_cmplog .env.docker
          cat /shellphish/guest_content/Dockerfile.extensions >> Dockerfile
          make docker-build
          ./run.sh build

          rsync -raz $TEMP_DIR/ {{ built_target | shquote }}/
